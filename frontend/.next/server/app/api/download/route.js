"use strict";(()=>{var e={};e.id=182,e.ids=[182],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},56115:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>S,patchFetch:()=>N,requestAsyncStorage:()=>y,routeModule:()=>f,serverHooks:()=>q,staticGenerationAsyncStorage:()=>g});var o={};t.r(o),t.d(o,{POST:()=>h});var n=t(49303),s=t(88716),a=t(60670),i=t(87070),p=t(24263),u=t(22298),d=t(58567),l=t(5161),c=t(16725),m=t.n(c),w=t(9487);async function x(e){return(await p.Z.get(`https://gateway.pinata.cloud/ipfs/${e}`,{responseType:"text"})).data}async function h(e){try{let r;let{fileId:t,user:o}=await e.json();if(!t||!o)return i.NextResponse.json({error:"File ID and user required"},{status:400});let n=await w.$.findOne({fileId:t});if(!n)return i.NextResponse.json({error:"File not found"},{status:404});if(n.linkExpiresAt&&Date.now()/1e3>n.linkExpiresAt)return i.NextResponse.json({error:"Share link has expired"},{status:410});let s=process.env.NEXT_PUBLIC_CONTRACT_ADDRESS,a=process.env.PRIVATE_KEY||process.env.NEXT_PUBLIC_PRIVATE_KEY;if(s&&a)try{let e=new u.r6("https://rpc-amoy.polygon.technology"),n=new d.w(a,e),p=new l.CH(s,["function hasAccess(string memory fileId, address user) view returns (bool)","function recordDownload(string memory fileId, address user)"],n);if(!await p.hasAccess(t,o))return i.NextResponse.json({error:"Access denied"},{status:403});try{let e=await p.recordDownload(t,o);await e.wait(),r=e.hash}catch(e){console.error("Blockchain record download error:",e)}}catch(e){console.error("Blockchain access check error:",e)}let p=await x(n.ipfsHash),c=function(e,r){let t=m().AES.decrypt(e,r);return Buffer.from(t.toString(m().enc.Utf8),"base64")}(p,n.encryptedKey);return n.downloadCount++,n.downloads.push({user:o,timestamp:new Date,txHash:r}),await n.save(),new i.NextResponse(new Uint8Array(c),{headers:{"Content-Type":"application/octet-stream","Content-Disposition":`attachment; filename="${n.fileName}"`}})}catch(e){return console.error("Download error:",e),i.NextResponse.json({error:"Download failed",message:e.message},{status:500})}}(0,w.u)();let f=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/download/route",pathname:"/api/download",filename:"route",bundlePath:"app/api/download/route"},resolvedPagePath:"C:\\Users\\BMSIT\\PolyDropBox\\frontend\\app\\api\\download\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:y,staticGenerationAsyncStorage:g,serverHooks:q}=f,S="/api/download/route";function N(){return(0,a.patchFetch)({serverHooks:q,staticGenerationAsyncStorage:g})}},9487:(e,r,t)=>{t.d(r,{$:()=>p,u:()=>a});var o=t(11185),n=t.n(o);let s=process.env.MONGODB_URI||process.env.NEXT_PUBLIC_MONGODB_URI||"mongodb://localhost:27017/polydropbox";function a(){n().connections[0]?.readyState||n().connect(s)}let i=new(n()).Schema({fileId:{type:String,required:!0,unique:!0},fileName:String,fileSize:Number,ipfsHash:String,encryptedKey:String,creator:String,price:Number,expiryTime:Number,maxDownloads:Number,downloadCount:{type:Number,default:0},burnAfterDownload:Boolean,enableCrossChain:Boolean,createdAt:{type:Date,default:Date.now},previewHash:String,sharePasswordHash:String,linkExpiresAt:Number,mimeType:String,downloads:[{user:String,timestamp:Date,txHash:String}]}),p=n().models.File||n().model("File",i)}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[948,972,263,900,725],()=>t(56115));module.exports=o})();