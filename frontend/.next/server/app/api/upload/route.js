"use strict";(()=>{var e={};e.id=998,e.ids=[998],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},57441:e=>{e.exports=require("sharp")},27790:e=>{e.exports=require("assert")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},32694:e=>{e.exports=require("http2")},35240:e=>{e.exports=require("https")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},6005:e=>{e.exports=require("node:crypto")},49636:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>E,patchFetch:()=>q,requestAsyncStorage:()=>b,routeModule:()=>A,serverHooks:()=>I,staticGenerationAsyncStorage:()=>N});var a={};t.r(a),t.d(a,{POST:()=>S});var o=t(49303),n=t(88716),i=t(60670),s=t(87070),p=t(84770),l=t.n(p),u=t(16725),d=t.n(u),c=t(24263),f=t(22298),h=t(58567),m=t(5161),g=t(92491),w=t(9487);(0,w.u)();let x=process.env.PINATA_API_KEY||process.env.NEXT_PUBLIC_PINATA_API_KEY,y=process.env.PINATA_SECRET_KEY||process.env.NEXT_PUBLIC_PINATA_SECRET_KEY;async function v(e,r){let t=new FormData,a=new Blob([new Uint8Array(e)]);return t.append("file",a,r),t.append("pinataMetadata",JSON.stringify({name:r})),t.append("pinataOptions",JSON.stringify({cidVersion:0})),(await c.Z.post("https://api.pinata.cloud/pinning/pinFileToIPFS",t,{headers:{pinata_api_key:x,pinata_secret_api_key:y},maxBodyLength:1/0})).data.IpfsHash}async function P(e,r,a){try{let a=r.toLowerCase().split(".").pop(),o=["jpg","jpeg","png","gif","webp"].includes(a||""),n="pdf"===a;if(o){let a=(await Promise.resolve().then(t.t.bind(t,57441,23))).default,o=await a(e).resize(400,400,{fit:"inside"}).blur(15).png().toBuffer();return v(o,`preview_${r}.png`)}if(n){let{PDFDocument:a}=await t.e(271).then(t.bind(t,6271)),o=await a.load(e);if(o.getPages().length>0){let e=await a.create(),[t]=await e.copyPages(o,[0]);e.addPage(t);let n=await e.save();return v(Buffer.from(n),`preview_${r}`)}}}catch(e){console.error("Preview generation failed:",e)}return null}async function _(e,r){var t;let a=l().randomBytes(16).toString("hex"),o=await e.arrayBuffer(),n=Buffer.from(o),i=l().randomBytes(32).toString("hex"),s=d().AES.encrypt(n.toString("base64"),i).toString(),p=Buffer.from(s,"utf8"),u=await v(p,e.name),c=null,x=e.type||"application/octet-stream";try{c=await P(n,e.name,x)}catch(e){}let y=Math.floor(Date.now()/1e3)+3600*parseInt(r.expiryHours),_=r.linkExpiryHours?Math.floor(Date.now()/1e3)+3600*parseInt(r.linkExpiryHours):void 0,S=new w.$({fileId:a,fileName:e.name,fileSize:e.size,ipfsHash:u,encryptedKey:i,creator:r.creator,price:parseFloat(r.price||"0"),expiryTime:y,maxDownloads:parseInt(r.maxDownloads||"1"),burnAfterDownload:r.burnAfterDownload,enableCrossChain:r.enableCrossChain,previewHash:c||void 0,sharePasswordHash:r.sharePassword?(t=r.sharePassword,l().createHash("sha256").update(t).digest("hex")):void 0,linkExpiresAt:_,mimeType:x});await S.save();let A=process.env.NEXT_PUBLIC_CONTRACT_ADDRESS,b=process.env.PRIVATE_KEY||process.env.NEXT_PUBLIC_PRIVATE_KEY;if(A&&b)try{let e=new f.r6("https://rpc-amoy.polygon.technology"),t=new h.w(b,e),o=new m.CH(A,["function createFile(string memory fileId, string memory ipfsHash, uint256 price, uint256 expiryTime, uint256 maxDownloads, bool burnAfterDownload)"],t),n=g.vz(r.price||"0",6),i=await o.createFile(a,u,n,y,parseInt(r.maxDownloads||"1"),r.burnAfterDownload);await i.wait()}catch(e){console.error("Blockchain error:",e)}return{fileId:a,fileName:e.name,shareLink:`http://localhost:3000/file/${a}`}}async function S(e){try{let r=await e.formData(),t=r.get("creator");if(!t)return s.NextResponse.json({error:"Creator address required"},{status:400});let a=r.get("price")||"0",o=r.get("expiryHours")||"24",n=r.get("maxDownloads")||"1",i="true"===r.get("burnAfterDownload"),p="false"!==r.get("enableCrossChain"),l=r.get("sharePassword"),u=r.get("linkExpiryHours"),d={price:a,expiryHours:o,maxDownloads:n,burnAfterDownload:i,enableCrossChain:p,creator:t,sharePassword:l||void 0,linkExpiryHours:u||void 0},c=r.getAll("file").filter(e=>e&&e.size>0);if(0===c.length)return s.NextResponse.json({error:"No files uploaded"},{status:400});let f=[];for(let e of c){let r=await _(e,d);f.push(r)}return s.NextResponse.json({success:!0,count:f.length,files:f,fileId:f[0]?.fileId,shareLink:1===f.length?`http://localhost:3000/file/${f[0].fileId}`:void 0})}catch(e){return console.error("Upload error:",e),s.NextResponse.json({error:"Upload failed",message:e.message},{status:500})}}let A=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/upload/route",pathname:"/api/upload",filename:"route",bundlePath:"app/api/upload/route"},resolvedPagePath:"C:\\Users\\BMSIT\\PolyDropBox\\frontend\\app\\api\\upload\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:b,staticGenerationAsyncStorage:N,serverHooks:I}=A,E="/api/upload/route";function q(){return(0,i.patchFetch)({serverHooks:I,staticGenerationAsyncStorage:N})}},9487:(e,r,t)=>{t.d(r,{$:()=>p,u:()=>i});var a=t(11185),o=t.n(a);let n=process.env.MONGODB_URI||process.env.NEXT_PUBLIC_MONGODB_URI||"mongodb://localhost:27017/polydropbox";function i(){o().connections[0]?.readyState||o().connect(n)}let s=new(o()).Schema({fileId:{type:String,required:!0,unique:!0},fileName:String,fileSize:Number,ipfsHash:String,encryptedKey:String,creator:String,price:Number,expiryTime:Number,maxDownloads:Number,downloadCount:{type:Number,default:0},burnAfterDownload:Boolean,enableCrossChain:Boolean,createdAt:{type:Date,default:Date.now},previewHash:String,sharePasswordHash:String,linkExpiresAt:Number,mimeType:String,downloads:[{user:String,timestamp:Date,txHash:String}]}),p=o().models.File||o().model("File",s)}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),a=r.X(0,[948,972,263,900,725,491],()=>t(49636));module.exports=a})();